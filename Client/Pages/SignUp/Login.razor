@using Api.Models
@using Client.Helpers

@using Client.Services
@inject NavigationManager NavigationManager
@inject IAccountService AccountService
@inject IAlertService AlertService

@page "/Login"

<div class="empty-space"></div>

<MudLayout>
    <MudContainer MaxWidth="MaxWidth.Medium">
        <h3>Login</h3>

        <MudPaper class="pa-4 LogInLayout">
            <MudForm @ref="form">
                <MudTextField T="string" Label="Username" class="LogInForm" Varian="Variant.Outlined" @bind-Value="username" RequiredError="User name is required!"/>
                <MudTextField T="string" Immediate="true" @onkeydown="@Enter" Label="Password" @bind-Value="password" InputType="InputType.Password"/>
                <div class="d-flex align-center justify-space-between mt-6">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" OnClick="@(() => LoginFunc())">Login</MudButton>
                </div>
            </MudForm>
        </MudPaper>
        <MudText Color="@Color.Error">
            @errorUsernameIncorrectField
        </MudText>
        <MudPaper Class="pa-4 mt-4" Width="350px">
            <MudText> Don't have an account? Register right now </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" DisableElevation="true" Href="/Signup">Sign up</MudButton>
        </MudPaper>
    </MudContainer>
</MudLayout>

@code {

    string errorUsernameIncorrect { get; set; }
    string errorUsernameIncorrectField { get; set; }
    string password;
    string username;
    MudForm form;

    IDbAccess DbAccess = new DbAccess();
    private bool authenticated;

    private Models.Account.Login? model = new Models.Account.Login();
    private bool loading;

    private async void LoginFunc()
    {
        model.Username = username;
        model.Password = password;
        AlertService.Clear();

        loading = true;
        try
        {
            await AccountService.Login(model);
            var returnUrl = NavigationManager.QueryString("returnUrl") ?? "";
            NavigationManager.NavigateTo(returnUrl);
        }
        catch (Exception ex)
        {
            AlertService.Error(ex.Message);
            loading = false;
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        var timer = new System.Timers.Timer(1000);
        timer.Elapsed += (s, e) =>
        {
            InvokeAsync(() =>
            {
                errorUsernameIncorrectField = errorUsernameIncorrect;
                StateHasChanged();
            });
        };
        timer.Start();
    }
    
    private void Enter(KeyboardEventArgs e)
    {
        if (e.Code is not ("Enter" or "NumpadEnter")) return;
        LoginFunc();
    }
}